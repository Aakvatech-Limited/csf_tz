{
 "add_total_row": 1,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-12-23 18:57:51.098939",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "javascript": "frappe.query_reports[\"Sales Transaction Currency Recon\"] = {\r\n  filters: [\r\n    {\r\n      fieldname: \"company\",\r\n      label: __(\"Company\"),\r\n      fieldtype: \"Link\",\r\n      options: \"Company\",\r\n      default: frappe.defaults.get_user_default(\"Company\"),\r\n    },\r\n    {\r\n      fieldname: \"from_date\",\r\n      label: __(\"From Date\"),\r\n      fieldtype: \"Date\",\r\n      reqd: 1,\r\n      default: frappe.datetime.add_months(frappe.datetime.get_today(), -1),\r\n    },\r\n    {\r\n      fieldname: \"to_date\",\r\n      label: __(\"To Date\"),\r\n      fieldtype: \"Date\",\r\n      reqd: 1,\r\n      default: frappe.datetime.get_today(),\r\n    },\r\n    {\r\n      fieldname: \"customer\",\r\n      label: __(\"Customer\"),\r\n      fieldtype: \"Link\",\r\n      options: \"Customer\",\r\n    },\r\n    {\r\n      fieldname: \"view\",\r\n      label: __(\"View\"),\r\n      fieldtype: \"Select\",\r\n      options: [\"Detailed\", \"Grouped by Customer\"],\r\n      default: \"Detailed\",\r\n      reqd: 1,\r\n    },\r\n  ],\r\n};\r\n",
 "letter_head": "Standard Letter Head",
 "letterhead": null,
 "modified": "2025-12-23 23:12:02.436318",
 "modified_by": "Administrator",
 "module": "CSF TZ",
 "name": "Sales Transaction Currency Recon",
 "owner": "mchoksi@aakvatech.com",
 "prepared_report": 0,
 "ref_doctype": "Sales Invoice",
 "report_name": "Sales Transaction Currency Recon",
 "report_script": "def validate_filters(filters):\r\n    if not filters.get(\"from_date\") or not filters.get(\"to_date\"):\r\n        frappe.throw(\"From Date and To Date are required.\")\r\n\r\n    if filters.from_date > filters.to_date:\r\n        frappe.throw(\"From Date cannot be after To Date.\")\r\n\r\n\r\ndef get_columns(filters):\r\n    currency_fields = [\r\n        {\r\n            \"label\": \"Ordered Amount (Txn)\",\r\n            \"fieldname\": \"ordered_amount\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"currency\",\r\n            \"width\": 150,\r\n        },\r\n        {\r\n            \"label\": \"Ordered Amount (Company)\",\r\n            \"fieldname\": \"ordered_amount_company\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"company_currency\",\r\n            \"width\": 170,\r\n        },\r\n        {\r\n            \"label\": \"Received Amount (Txn)\",\r\n            \"fieldname\": \"received_amount\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"currency\",\r\n            \"width\": 150,\r\n        },\r\n        {\r\n            \"label\": \"Received Amount (Company)\",\r\n            \"fieldname\": \"received_amount_company\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"company_currency\",\r\n            \"width\": 170,\r\n        },\r\n        {\r\n            \"label\": \"Billed Amount (Txn)\",\r\n            \"fieldname\": \"billed_amount\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"currency\",\r\n            \"width\": 150,\r\n        },\r\n        {\r\n            \"label\": \"Billed Amount (Company)\",\r\n            \"fieldname\": \"billed_amount_company\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"company_currency\",\r\n            \"width\": 170,\r\n        },\r\n        {\r\n            \"label\": \"Ordered - Received (Txn)\",\r\n            \"fieldname\": \"ordered_minus_received\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"currency\",\r\n            \"width\": 180,\r\n        },\r\n        {\r\n            \"label\": \"Ordered - Billed (Txn)\",\r\n            \"fieldname\": \"ordered_minus_billed\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"currency\",\r\n            \"width\": 180,\r\n        },\r\n        {\r\n            \"label\": \"Billed - Received (Txn)\",\r\n            \"fieldname\": \"billed_minus_received\",\r\n            \"fieldtype\": \"Currency\",\r\n            \"options\": \"currency\",\r\n            \"width\": 180,\r\n        },\r\n    ]\r\n\r\n    return [\r\n        {\"label\": \"Customer\", \"fieldname\": \"customer\", \"fieldtype\": \"Link\", \"options\": \"Customer\", \"width\": 180},\r\n        {\"label\": \"Doc Type\", \"fieldname\": \"doc_type\", \"fieldtype\": \"Data\", \"width\": 130},\r\n        {\"label\": \"Doc No\", \"fieldname\": \"doc_no\", \"fieldtype\": \"Dynamic Link\", \"options\": \"doc_type\", \"width\": 180},\r\n        {\"label\": \"Date\", \"fieldname\": \"posting_date\", \"fieldtype\": \"Date\", \"width\": 110},\r\n        {\"label\": \"Currency\", \"fieldname\": \"currency\", \"fieldtype\": \"Link\", \"options\": \"Currency\", \"width\": 90},\r\n        {\"label\": \"Company Currency\", \"fieldname\": \"company_currency\", \"fieldtype\": \"Link\", \"options\": \"Currency\", \"width\": 120},\r\n        {\"label\": \"Exchange Rate\", \"fieldname\": \"exchange_rate\", \"fieldtype\": \"Float\", \"width\": 110},\r\n        {\"label\": \"Item Code\", \"fieldname\": \"item_code\", \"fieldtype\": \"Link\", \"options\": \"Item\", \"width\": 140},\r\n        {\"label\": \"Item Name\", \"fieldname\": \"item_name\", \"fieldtype\": \"Data\", \"width\": 180},\r\n        *currency_fields,\r\n    ]\r\n\r\n\r\n\r\ndef get_common_conditions(filters, date_field, customer_field):\r\n    conditions = [f\"{date_field} BETWEEN %(from_date)s AND %(to_date)s\"]\r\n    values = {\r\n        \"from_date\": filters.from_date,\r\n        \"to_date\": filters.to_date,\r\n    }\r\n\r\n    if filters.get(\"customer\"):\r\n        conditions.append(f\"{customer_field} = %(customer)s\")\r\n        values[\"customer\"] = filters.customer\r\n\r\n    if filters.get(\"company\"):\r\n        # Each doctype uses company field name:\r\n        # - Sales Order: company\r\n        # - Sales Invoice: company\r\n        # - Payment Entry: company\r\n        conditions.append(\"company = %(company)s\")\r\n        values[\"company\"] = filters.company\r\n\r\n    return \" AND \".join(conditions), values\r\n\r\n\r\ndef group_by_customer(rows):\r\n    grouped = {}\r\n\r\n    for r in rows:\r\n        key = (r.get(\"customer\") or \"\")\r\n        if key not in grouped:\r\n            grouped[key] = {\r\n                \"customer\": r.get(\"customer\"),\r\n                \"doc_type\": \"Grouped\",\r\n                \"doc_no\": None,\r\n                \"posting_date\": None,\r\n                \"currency\": None,\r\n                \"company_currency\": r.get(\"company_currency\"),\r\n                \"exchange_rate\": None,\r\n                \"item_code\": None,\r\n                \"item_name\": None,\r\n                \"ordered_amount\": 0,\r\n                \"ordered_amount_company\": 0,\r\n                \"received_amount\": 0,\r\n                \"received_amount_company\": 0,\r\n                \"billed_amount\": 0,\r\n                \"billed_amount_company\": 0,\r\n            }\r\n\r\n        g = grouped[key]\r\n        g[\"ordered_amount\"] = g[\"ordered_amount\"] + flt(r.get(\"ordered_amount\"))\r\n        g[\"ordered_amount_company\"] = g[\"ordered_amount_company\"] + flt(r.get(\"ordered_amount_company\"))\r\n        g[\"received_amount\"] = g[\"received_amount\"] + flt(r.get(\"received_amount\"))\r\n        g[\"received_amount_company\"] = g[\"received_amount_company\"] + flt(r.get(\"received_amount_company\"))\r\n        g[\"billed_amount\"] = g[\"billed_amount\"] + flt(r.get(\"billed_amount\"))\r\n        g[\"billed_amount_company\"] = g[\"billed_amount_company\"] + flt(r.get(\"billed_amount_company\"))\r\n\r\n    return list(grouped.values())\r\n\r\ndef get_sales_order_rows(filters, company_currency):\r\n    conditions, values = get_common_conditions(filters, date_field=\"so.transaction_date\", customer_field=\"so.customer\")\r\n\r\n    # Sales Order Item amounts:\r\n    # - Transaction currency: soi.net_amount\r\n    # - Company currency: soi.base_net_amount\r\n    q = f\"\"\"\r\n        SELECT\r\n            so.customer AS customer,\r\n            'Sales Order' AS doc_type,\r\n            so.name AS doc_no,\r\n            so.transaction_date AS posting_date,\r\n            so.currency AS currency,\r\n            %(company_currency)s AS company_currency,\r\n            so.conversion_rate AS exchange_rate,\r\n            soi.item_code AS item_code,\r\n            soi.item_name AS item_name,\r\n            soi.net_amount AS ordered_amount,\r\n            soi.base_net_amount AS ordered_amount_company,\r\n            0 AS received_amount,\r\n            0 AS received_amount_company,\r\n            0 AS billed_amount,\r\n            0 AS billed_amount_company\r\n        FROM `tabSales Order` so\r\n        INNER JOIN `tabSales Order Item` soi ON soi.parent = so.name\r\n        WHERE so.docstatus = 1\r\n          AND {conditions}\r\n    \"\"\"\r\n    values[\"company_currency\"] = company_currency\r\n    return frappe.db.sql(q, values, as_dict=True)\r\n\r\n\r\ndef get_sales_invoice_rows(filters, company_currency):\r\n    conditions, values = get_common_conditions(filters, date_field=\"si.posting_date\", customer_field=\"si.customer\")\r\n\r\n    # Sales Invoice Item amounts:\r\n    # - Transaction currency: sii.net_amount\r\n    # - Company currency: sii.base_net_amount\r\n    # Note: returns (credit notes) are part of Sales Invoice with is_return=1; net_amount will typically be negative.\r\n    q = f\"\"\"\r\n        SELECT\r\n            si.customer AS customer,\r\n            'Sales Invoice' AS doc_type,\r\n            si.name AS doc_no,\r\n            si.posting_date AS posting_date,\r\n            si.currency AS currency,\r\n            %(company_currency)s AS company_currency,\r\n            si.conversion_rate AS exchange_rate,\r\n            sii.item_code AS item_code,\r\n            sii.item_name AS item_name,\r\n            0 AS ordered_amount,\r\n            0 AS ordered_amount_company,\r\n            0 AS received_amount,\r\n            0 AS received_amount_company,\r\n            sii.net_amount AS billed_amount,\r\n            sii.base_net_amount AS billed_amount_company\r\n        FROM `tabSales Invoice` si\r\n        INNER JOIN `tabSales Invoice Item` sii ON sii.parent = si.name\r\n        WHERE si.docstatus = 1\r\n          AND {conditions}\r\n    \"\"\"\r\n    values[\"company_currency\"] = company_currency\r\n    return frappe.db.sql(q, values, as_dict=True)\r\n\r\n\r\ndef get_payment_rows(filters, company_currency):\r\n    # We use Payment Entry Reference to relate payments to Sales Invoices (most common reconciliation use case).\r\n    # Sign convention requested:\r\n    # - received = negative value if received\r\n    # - received = positive value if refunded\r\n    #\r\n    # Mapping:\r\n    # - Payment Entry.payment_type = 'Receive' => received money => negative\r\n    # - Payment Entry.payment_type = 'Pay' => refund money => positive\r\n    #\r\n    # Amount selection:\r\n    # - per reference: `tabPayment Entry Reference`.`allocated_amount`\r\n    # - company currency: allocated_amount * exchange_rate (best-effort)\r\n    #\r\n    # If your setup uses multi-currency bank accounts heavily, you may want to enhance this using\r\n    # paid_from_account_currency/paid_to_account_currency and base_* fields.\r\n    conditions, values = get_common_conditions(filters, date_field=\"pe.posting_date\", customer_field=\"pe.party\")\r\n\r\n    q = f\"\"\"\r\n        SELECT\r\n            pe.party AS customer,\r\n            'Payment Entry' AS doc_type,\r\n            pe.name AS doc_no,\r\n            pe.posting_date AS posting_date,\r\n            pe.paid_from_account_currency AS currency,\r\n            %(company_currency)s AS company_currency,\r\n            pe.source_exchange_rate AS exchange_rate,\r\n            NULL AS item_code,\r\n            NULL AS item_name,\r\n            0 AS ordered_amount,\r\n            0 AS ordered_amount_company,\r\n            (\r\n                CASE\r\n                    WHEN pe.payment_type = 'Receive' THEN -per.allocated_amount\r\n                    WHEN pe.payment_type = 'Pay' THEN per.allocated_amount\r\n                    ELSE 0\r\n                END\r\n            ) AS received_amount,\r\n            (\r\n                CASE\r\n                    WHEN pe.payment_type = 'Receive' THEN -per.allocated_amount * IFNULL(pe.source_exchange_rate, 1)\r\n                    WHEN pe.payment_type = 'Pay' THEN  per.allocated_amount * IFNULL(pe.source_exchange_rate, 1)\r\n                    ELSE 0\r\n                END\r\n            ) AS received_amount_company,\r\n            0 AS billed_amount,\r\n            0 AS billed_amount_company\r\n        FROM `tabPayment Entry` pe\r\n        INNER JOIN `tabPayment Entry Reference` per ON per.parent = pe.name\r\n        WHERE pe.docstatus = 1\r\n          AND pe.party_type = 'Customer'\r\n          AND per.reference_doctype IN ('Sales Invoice')\r\n          AND {conditions}\r\n    \"\"\"\r\n    values[\"company_currency\"] = company_currency\r\n    return frappe.db.sql(q, values, as_dict=True)\r\n\r\n\r\ndef get_rows(filters):\r\n    company = filters.get(\"company\") or frappe.defaults.get_user_default(\"Company\")\r\n    company_currency = frappe.db.get_value(\"Company\", company, \"default_currency\")\r\n\r\n    rows = []\r\n    rows.extend(get_sales_order_rows(filters, company_currency))\r\n    rows.extend(get_sales_invoice_rows(filters, company_currency))\r\n    rows.extend(get_payment_rows(filters, company_currency))\r\n\r\n    # Optional: sort by date then doc\r\n    rows.sort(key=lambda r: (r.get(\"posting_date\") or \"\", r.get(\"doc_type\") or \"\", r.get(\"doc_no\") or \"\"))\r\n    return rows\r\n\r\n\r\nvalidate_filters(filters)\r\n\r\ncolumns = get_columns(filters)\r\nrows = get_rows(filters)\r\n\r\nif filters.get(\"view\") == \"Grouped by Customer\":\r\n    rows = group_by_customer(rows)\r\n\r\nfor r in rows:\r\n    r[\"ordered_minus_received\"] = flt(r.get(\"ordered_amount\")) - flt(r.get(\"received_amount\"))\r\n    r[\"ordered_minus_billed\"] = flt(r.get(\"ordered_amount\")) - flt(r.get(\"billed_amount\"))\r\n    r[\"billed_minus_received\"] = flt(r.get(\"billed_amount\")) - flt(r.get(\"received_amount\"))\r\n\r\ndata = columns, rows\r\n",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Accounts Manager"
  },
  {
   "role": "System Manager"
  },
  {
   "role": "Site Setup"
  },
  {
   "role": "Employee Self Service"
  },
  {
   "role": "Employee"
  },
  {
   "role": "Technical Team"
  },
  {
   "role": "AV Sales Admin"
  }
 ],
 "timeout": 0
}