name: Enforce PR Base Branch

on:
  pull_request_target:
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write

env:
  DISALLOWED_BASE_BRANCHES: "version-15,version-16"

jobs:
  enforce-base-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce disallowed PR base branches
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- hotfix-branch-policy -->';
            const disallowed = process.env.DISALLOWED_BASE_BRANCHES
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean);

            const base = context.payload.pull_request.base.ref;
            if (!disallowed.includes(base)) {
              core.info(`PR base branch '${base}' is allowed.`);
              return;
            }

            const issue_number = context.payload.pull_request.number;
            const { owner, repo } = context.repo;
            const disallowedText = disallowed.map((b) => `\`${b}\``).join(', ');

            const body = `${marker}\n@${context.payload.pull_request.user.login} this PR targets \`${base}\`, which is blocked for direct contributions.\n\nPlease re-open this PR against a hotfix branch (for example \`version-15-hotfix\` or \`version-16-hotfix\`).\n\nBlocked branches: ${disallowedText}.`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const alreadyCommented = comments.some((comment) =>
              typeof comment.body === 'string' && comment.body.includes(marker)
            );

            if (!alreadyCommented) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: issue_number,
              state: 'closed',
            });
